{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://battleforge.battlewithbytes.com/schemas/wasm-manifest-v1.json",
  "title": "BattleForge WASM Manifest",
  "description": "Schema for WASM compiler/linker/disassembler/emulator versioning and metadata",
  "type": "object",
  "required": [
    "schemaVersion",
    "lastUpdated",
    "compilers"
  ],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version for this manifest format"
    },
    "lastUpdated": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of last manifest update"
    },
    "releaseChannel": {
      "type": "string",
      "enum": [
        "stable",
        "beta",
        "nightly"
      ],
      "default": "stable",
      "description": "Release channel for this manifest"
    },
    "compilers": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/compiler"
      },
      "description": "List of available compilers"
    },
    "linkers": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/linker"
      },
      "description": "List of available linkers"
    },
    "disassemblers": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/disassembler"
      },
      "description": "List of available disassemblers"
    },
    "meta": {
      "type": "object",
      "properties": {
        "cdnBaseUrl": {
          "type": "string",
          "format": "uri",
          "description": "CDN base URL for WASM files"
        },
        "fallbackBaseUrl": {
          "type": "string",
          "description": "Fallback base URL (relative path)"
        },
        "checksumAlgorithm": {
          "type": "string",
          "enum": [
            "sha256",
            "sha384",
            "sha512"
          ],
          "default": "sha256"
        }
      }
    },
    "emulators": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/emulator"
      },
      "description": "List of available emulators"
    }
  },
  "definitions": {
    "versionInfo": {
      "type": "object",
      "required": [
        "softwareVersion",
        "releaseVersion"
      ],
      "properties": {
        "softwareVersion": {
          "type": "string",
          "description": "Upstream software version (e.g., LLVM 21.1.4)"
        },
        "releaseVersion": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "BattleForge build/release version (semver)"
        },
        "fullVersion": {
          "type": "string",
          "description": "Combined version for display (e.g., 21.1.4-r1.0.0)"
        }
      }
    },
    "fileInfo": {
      "type": "object",
      "required": [
        "wasm",
        "js"
      ],
      "properties": {
        "wasm": {
          "type": "string",
          "description": "Path to WASM file (may be .wasm or .wasm.gz)"
        },
        "js": {
          "type": "string",
          "description": "Path to JavaScript loader file"
        }
      }
    },
    "hashInfo": {
      "type": "object",
      "required": [
        "compressed"
      ],
      "properties": {
        "compressed": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA256 hash of compressed WASM file"
        },
        "uncompressed": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA256 hash of uncompressed WASM file"
        }
      }
    },
    "buildInfo": {
      "type": "object",
      "properties": {
        "llvmCommit": {
          "type": "string",
          "description": "LLVM git commit hash used for build"
        },
        "buildDate": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of build"
        },
        "buildScript": {
          "type": "string",
          "description": "Name of build script used"
        },
        "buildHost": {
          "type": "string",
          "description": "Build host identifier"
        }
      }
    },
    "compiler": {
      "type": "object",
      "required": [
        "id",
        "name",
        "softwareVersion",
        "releaseVersion",
        "files",
        "hashes",
        "architectures"
      ],
      "allOf": [
        {
          "$ref": "#/definitions/versionInfo"
        }
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Unique compiler identifier (e.g., clang-arm)"
        },
        "name": {
          "type": "string",
          "description": "Human-readable name"
        },
        "description": {
          "type": "string",
          "description": "Detailed description"
        },
        "status": {
          "type": "string",
          "enum": [
            "stable",
            "beta",
            "deprecated",
            "coming_soon"
          ],
          "default": "stable"
        },
        "releaseNotes": {
          "type": "string",
          "description": "Notes about this release"
        },
        "releaseDate": {
          "type": "string",
          "format": "date",
          "description": "Release date (YYYY-MM-DD)"
        },
        "files": {
          "$ref": "#/definitions/fileInfo"
        },
        "size": {
          "type": "integer",
          "minimum": 0,
          "description": "Compressed file size in bytes"
        },
        "sizeUncompressed": {
          "type": "integer",
          "minimum": 0,
          "description": "Uncompressed file size in bytes"
        },
        "hashes": {
          "$ref": "#/definitions/hashInfo"
        },
        "architectures": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "Supported target architectures"
        },
        "buildInfo": {
          "$ref": "#/definitions/buildInfo"
        },
        "minAppVersion": {
          "type": "string",
          "description": "Minimum BattleForge app version required"
        },
        "deprecationDate": {
          "type": [
            "string",
            "null"
          ],
          "format": "date",
          "description": "Date when this version will be deprecated"
        }
      }
    },
    "linker": {
      "type": "object",
      "required": [
        "id",
        "name",
        "softwareVersion",
        "releaseVersion",
        "files",
        "hashes"
      ],
      "allOf": [
        {
          "$ref": "#/definitions/versionInfo"
        }
      ],
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "files": {
          "$ref": "#/definitions/fileInfo"
        },
        "size": {
          "type": "integer"
        },
        "hashes": {
          "$ref": "#/definitions/hashInfo"
        },
        "architectures": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "disassembler": {
      "type": "object",
      "required": [
        "id",
        "name",
        "softwareVersion",
        "releaseVersion",
        "files",
        "hashes"
      ],
      "allOf": [
        {
          "$ref": "#/definitions/versionInfo"
        }
      ],
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "files": {
          "type": "object",
          "properties": {
            "wasm": {
              "type": "string"
            },
            "wasmGz": {
              "type": "string"
            },
            "js": {
              "type": "string"
            },
            "api": {
              "type": "string"
            }
          }
        },
        "size": {
          "type": "integer"
        },
        "sizeCompressed": {
          "type": "integer"
        },
        "hashes": {
          "$ref": "#/definitions/hashInfo"
        },
        "architectures": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "features": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "emulator": {
      "type": "object",
      "required": [
        "id",
        "name",
        "softwareVersion",
        "releaseVersion",
        "files",
        "hashes",
        "supportedCpus"
      ],
      "allOf": [
        {
          "$ref": "#/definitions/versionInfo"
        }
      ],
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "files": {
          "type": "object",
          "properties": {
            "wasm": {
              "type": "string"
            },
            "wasmGz": {
              "type": "string"
            },
            "js": {
              "type": "string"
            },
            "api": {
              "type": "string"
            }
          }
        },
        "size": {
          "type": "integer"
        },
        "sizeCompressed": {
          "type": "integer"
        },
        "hashes": {
          "$ref": "#/definitions/hashInfo"
        },
        "supportedCpus": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "List of supported CPU types (e.g., cortex-m0, cortex-m3)"
        },
        "hooks": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Available hook types (e.g., code, memory, interrupt)"
        }
      }
    }
  }
}
